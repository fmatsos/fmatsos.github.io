---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/molecules/Breadcrumb.astro';
import Badge from '../../components/atoms/Badge.astro';
import Link from '../../components/atoms/Link.astro';
import TagList from '../../components/molecules/TagList.astro';
import StructuredData from '../../components/molecules/StructuredData.astro';

const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.published && !data.draft);
  
  const years = [...new Set(posts.map(post => post.data.pubDate.getFullYear().toString()))];
  
  return years.map(year => ({
    params: { year },
    props: {
      year,
      posts: posts
        .filter(post => post.data.pubDate.getFullYear().toString() === year)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    }
  }));
}

const { year, posts } = Astro.props;

// Group posts by month
const postsByMonth = posts.reduce((acc, post) => {
  const month = post.data.pubDate.getMonth();
  if (!acc[month]) acc[month] = [];
  acc[month].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const monthEntries = Object.entries(postsByMonth).sort(([a], [b]) => Number(b) - Number(a));

const breadcrumbItems = [
  { label: 'Blog', href: '/blog' },
  { label: year }
];

// Schema.org BreadcrumbList
const breadcrumbList = {
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Accueil', item: 'https://franck.matsos.fr/' },
    { '@type': 'ListItem', position: 2, name: 'Blog', item: 'https://franck.matsos.fr/blog' },
    { '@type': 'ListItem', position: 3, name: year }
  ]
};

// Schema.org CollectionPage
const collectionPage = {
  name: `Articles de ${year}`,
  description: `Tous les articles publiés en ${year}`,
  url: `https://franck.matsos.fr/blog/${year}`,
  isPartOf: { '@type': 'Blog', '@id': 'https://franck.matsos.fr/blog' },
  about: { '@type': 'Thing', name: `Articles de l'année ${year}` }
};
---

<BaseLayout
  title={`Articles de ${year}`}
  description={`Tous les articles publiés en ${year}`}
  lang="fr"
  currentPath={Astro.url.pathname}
>
  <StructuredData type="BreadcrumbList" data={breadcrumbList} />
  <StructuredData type="CollectionPage" data={collectionPage} />
  
  <Breadcrumb items={breadcrumbItems} lang="fr" />
  
  <section class="space-y-6">
    <div class="space-y-3">
      <h1 class="section-title">
        <Badge variant="primary" class="text-2xl px-4 py-2">{year}</Badge>
      </h1>
      <p class="max-w-3xl section-lead">
        {posts.length} article{posts.length > 1 ? 's' : ''} publié{posts.length > 1 ? 's' : ''} en {year}, classés par mois.
      </p>
    </div>

    <div class="space-y-4">
      {monthEntries.map(([monthIndex, monthPosts], index) => {
        const monthLabel = monthNames[Number(monthIndex)];
        const monthNum = (Number(monthIndex) + 1).toString().padStart(2, '0');

        return (
          <div class="overflow-hidden border border-foreground/10 bg-background/70 shadow-lg dark:border-background-dark/30 dark:bg-background-dark/80">
            <details open={index === 0} class="group">
              <summary class="flex cursor-pointer items-center justify-between bg-foreground/5 px-5 py-3 text-lg font-semibold transition hover:bg-foreground/10 dark:bg-background-dark/70 dark:hover:bg-background-dark/60">
                <span class="flex items-center gap-3">
                  <svg class="h-5 w-5 transition-transform duration-300 group-open:rotate-90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 18l6-6-6-6"/>
                  </svg>
                  <a href={`/blog/${year}/${monthNum}`} class="hover:text-primary dark:hover:text-primary-dark transition-colors capitalize">
                    {monthLabel}
                  </a>
                </span>
                <Badge variant="primary" size="sm">
                  {monthPosts.length}&nbsp;{monthPosts.length > 1 ? 'articles' : 'article'}
                </Badge>
              </summary>
              <ul class="divide-y divide-foreground/10 dark:divide-background-dark/40" role="list" aria-label={`Articles de ${monthLabel} ${year}`}>
                {monthPosts.map((post) => (
                  <li class="flex flex-wrap items-center justify-between gap-3 px-5 py-3">
                    <div class="flex-1">
                      <Link href={`/blog/${post.slug}`} variant="default" class="text-lg font-medium">
                        {post.data.title}
                      </Link>
                      <p class="text-muted mt-1">
                        <time datetime={post.data.pubDate.toISOString()}>
                          {new Intl.DateTimeFormat('fr-FR', { dateStyle: 'long' }).format(post.data.pubDate)}
                        </time>
                      </p>
                    </div>
                    <TagList tags={post.data.tags} />
                  </li>
                ))}
              </ul>
            </details>
          </div>
        );
      })}
    </div>
  </section>
</BaseLayout>
