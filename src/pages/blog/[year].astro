---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageHeader from '../../components/organisms/PageHeader.astro';
import Breadcrumb from '../../components/molecules/Breadcrumb.astro';
import PostCard from '../../components/molecules/PostCard.astro';
import StructuredData from '../../components/molecules/StructuredData.astro';

const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.published && !data.draft);
  
  const years = [...new Set(posts.map(post => post.data.pubDate.getFullYear().toString()))];
  
  return years.map(year => ({
    params: { year },
    props: {
      year,
      posts: posts
        .filter(post => post.data.pubDate.getFullYear().toString() === year)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    }
  }));
}

const { year, posts } = Astro.props;

// Group posts by month
const postsByMonth = posts.reduce((acc, post) => {
  const month = post.data.pubDate.getMonth();
  if (!acc[month]) acc[month] = [];
  acc[month].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const breadcrumbItems = [
  { label: 'Blog', href: '/blog' },
  { label: year }
];

// Schema.org BreadcrumbList
const breadcrumbList = {
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Accueil', item: 'https://franck.matsos.fr/' },
    { '@type': 'ListItem', position: 2, name: 'Blog', item: 'https://franck.matsos.fr/blog' },
    { '@type': 'ListItem', position: 3, name: year }
  ]
};

// Schema.org CollectionPage
const collectionPage = {
  name: `Articles de ${year}`,
  description: `Tous les articles publiés en ${year}`,
  url: `https://franck.matsos.fr/blog/${year}`,
  isPartOf: { '@type': 'Blog', '@id': 'https://franck.matsos.fr/blog' },
  about: { '@type': 'Thing', name: `Articles de l'année ${year}` }
};
---

<BaseLayout
  title={`Articles de ${year}`}
  description={`Tous les articles publiés en ${year}`}
  lang="fr"
  currentPath={Astro.url.pathname}
>
  <StructuredData type="BreadcrumbList" data={breadcrumbList} />
  <StructuredData type="ItemList" data={collectionPage} />
  
  <Breadcrumb items={breadcrumbItems} lang="fr" />
  
  <PageHeader
    title={`Articles de ${year}`}
    description={`${posts.length} article${posts.length > 1 ? 's' : ''} publié${posts.length > 1 ? 's' : ''} en ${year}`}
  />

  <main aria-label={`Liste des articles de ${year}`} class="space-y-8">
    {Object.entries(postsByMonth)
      .sort(([a], [b]) => Number(b) - Number(a))
      .map(([monthIndex, monthPosts]) => (
        <section class="space-y-4" aria-labelledby={`month-${monthIndex}`}>
          <h2 id={`month-${monthIndex}`} class="text-xl font-semibold text-black dark:text-white flex-center-gap-2">
            <a href={`/blog/${year}/${(Number(monthIndex) + 1).toString().padStart(2, '0')}`} class="hover:text-primary dark:hover:text-primary-dark transition-colors">
              {monthNames[Number(monthIndex)]}
            </a>
            <span class="text-sm text-muted" aria-label={`${monthPosts.length} articles`}>({monthPosts.length})</span>
          </h2>
          <ul class="space-y-6" role="list">
            {monthPosts.map((post, index) => (
              <li class="animate-slide-in-right" style={`animation-delay: ${index * 80}ms`}>
                <PostCard
                  title={post.data.title}
                  description={post.data.description}
                  pubDate={post.data.pubDate}
                  tags={post.data.tags}
                  slug={post.slug}
                  lang="fr"
                />
              </li>
            ))}
          </ul>
        </section>
      ))}
  </main>
</BaseLayout>
