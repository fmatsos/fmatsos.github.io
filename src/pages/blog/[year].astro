---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageHeader from '../../components/organisms/PageHeader.astro';
import Breadcrumb from '../../components/molecules/Breadcrumb.astro';
import PostCard from '../../components/molecules/PostCard.astro';

const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.published && !data.draft);
  
  const years = [...new Set(posts.map(post => post.data.pubDate.getFullYear().toString()))];
  
  return years.map(year => ({
    params: { year },
    props: {
      year,
      posts: posts
        .filter(post => post.data.pubDate.getFullYear().toString() === year)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    }
  }));
}

const { year, posts } = Astro.props;

// Group posts by month
const postsByMonth = posts.reduce((acc, post) => {
  const month = post.data.pubDate.getMonth();
  if (!acc[month]) acc[month] = [];
  acc[month].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const breadcrumbItems = [
  { label: 'Blog', href: '/blog' },
  { label: year }
];
---

<BaseLayout
  title={`Articles de ${year}`}
  description={`Tous les articles publiés en ${year}`}
  lang="fr"
  currentPath={Astro.url.pathname}
>
  <Breadcrumb items={breadcrumbItems} lang="fr" />
  
  <PageHeader
    title={`Articles de ${year}`}
    description={`${posts.length} article${posts.length > 1 ? 's' : ''} publié${posts.length > 1 ? 's' : ''} en ${year}`}
  />

  <div class="space-y-8">
    {Object.entries(postsByMonth)
      .sort(([a], [b]) => Number(b) - Number(a))
      .map(([monthIndex, monthPosts]) => (
        <section class="space-y-4">
          <h2 class="text-xl font-semibold text-black dark:text-white flex-center-gap-2">
            <a href={`/blog/${year}/${(Number(monthIndex) + 1).toString().padStart(2, '0')}`} class="hover:text-primary dark:hover:text-primary-dark transition-colors">
              {monthNames[Number(monthIndex)]}
            </a>
            <span class="text-sm text-muted">({monthPosts.length})</span>
          </h2>
          <div class="space-y-6">
            {monthPosts.map((post, index) => (
              <div class="animate-slide-in-right" style={`animation-delay: ${index * 80}ms`}>
                <PostCard
                  title={post.data.title}
                  description={post.data.description}
                  pubDate={post.data.pubDate}
                  tags={post.data.tags}
                  slug={post.slug}
                  lang="fr"
                />
              </div>
            ))}
          </div>
        </section>
      ))}
  </div>
</BaseLayout>
