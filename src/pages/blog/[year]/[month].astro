---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumb from '../../../components/molecules/Breadcrumb.astro';
import Badge from '../../../components/atoms/Badge.astro';
import Link from '../../../components/atoms/Link.astro';
import TagList from '../../../components/molecules/TagList.astro';
import StructuredData from '../../../components/molecules/StructuredData.astro';

const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.published && !data.draft);
  
  const yearMonths = [...new Set(posts.map(post => {
    const year = post.data.pubDate.getFullYear().toString();
    const month = (post.data.pubDate.getMonth() + 1).toString().padStart(2, '0');
    return `${year}/${month}`;
  }))];
  
  return yearMonths.map(ym => {
    const [year, month] = ym.split('/');
    return {
      params: { year, month },
      props: {
        year,
        month,
        posts: posts
          .filter(post => {
            const postYear = post.data.pubDate.getFullYear().toString();
            const postMonth = (post.data.pubDate.getMonth() + 1).toString().padStart(2, '0');
            return postYear === year && postMonth === month;
          })
          .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
      }
    };
  });
}

const { year, month, posts } = Astro.props;
const monthName = monthNames[Number(month) - 1];

const breadcrumbItems = [
  { label: 'Blog', href: '/blog' },
  { label: year, href: `/blog/${year}` },
  { label: month }
];

// Schema.org BreadcrumbList
const breadcrumbList = {
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Accueil', item: 'https://franck.matsos.fr/' },
    { '@type': 'ListItem', position: 2, name: 'Blog', item: 'https://franck.matsos.fr/blog' },
    { '@type': 'ListItem', position: 3, name: year, item: `https://franck.matsos.fr/blog/${year}` },
    { '@type': 'ListItem', position: 4, name: monthName }
  ]
};

// Schema.org CollectionPage
const collectionPage = {
  name: `Articles de ${monthName} ${year}`,
  description: `Tous les articles publiés en ${monthName} ${year}`,
  url: `https://franck.matsos.fr/blog/${year}/${month}`,
  isPartOf: { '@type': 'Blog', '@id': 'https://franck.matsos.fr/blog' }
};
---

<BaseLayout
  title={`Articles de ${monthName} ${year}`}
  description={`Tous les articles publiés en ${monthName} ${year}`}
  lang="fr"
  currentPath={Astro.url.pathname}
>
  <StructuredData type="BreadcrumbList" data={breadcrumbList} />
  <StructuredData type="CollectionPage" data={collectionPage} />
  
  <Breadcrumb items={breadcrumbItems} lang="fr" />
  
  <section class="space-y-6">
    <div class="space-y-3">
      <h1 class="section-title">
        <Badge variant="primary" class="text-2xl px-4 py-2 capitalize">{monthName} {year}</Badge>
      </h1>
      <p class="max-w-3xl section-lead">
        {posts.length} article{posts.length > 1 ? 's' : ''} publié{posts.length > 1 ? 's' : ''} en {monthName} {year}.
      </p>
    </div>

    <div class="overflow-hidden border border-foreground/10 bg-background/70 shadow-lg dark:border-background-dark/30 dark:bg-background-dark/80">
      <ul class="divide-y divide-foreground/10 dark:divide-background-dark/40" role="list" aria-label={`Articles de ${monthName} ${year}`}>
        {posts.map((post) => (
          <li class="flex flex-wrap items-center justify-between gap-3 px-5 py-3">
            <div class="flex-1">
              <Link href={`/blog/${post.slug}`} variant="default" class="text-lg font-medium">
                {post.data.title}
              </Link>
              <p class="text-muted mt-1">
                <time datetime={post.data.pubDate.toISOString()}>
                  {new Intl.DateTimeFormat('fr-FR', { dateStyle: 'long' }).format(post.data.pubDate)}
                </time>
              </p>
            </div>
            <TagList tags={post.data.tags} />
          </li>
        ))}
      </ul>
    </div>
  </section>
</BaseLayout>
