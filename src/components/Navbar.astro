---
import { Icon } from 'astro-icon/components';
import { BASELINE, SITE_TITLE } from '../config';
import NavbarLink from './NavbarLink.astro';
import ThemeSelector from './ThemeSelector.astro';

interface Props {
  lang: 'fr' | 'en';
  currentPath?: string;
}

const { lang, currentPath = '/' } = Astro.props as Props;

const nav = lang === 'fr'
  ? [
      { href: '/', label: 'Accueil' },
      { href: '/a-propos', label: 'À propos' },
      { href: '/blog', label: 'Blog' },
    ]
  : [
      { href: '/en/', label: 'Home' },
      { href: '/en/about', label: 'About' },
      { href: '/en/blog', label: 'Blog' },
    ];

const languageSwitch = lang === 'fr'
  ? { label: 'English version', href: currentPath.startsWith('/blog') ? '/en/blog' : currentPath === '/a-propos' ? '/en/about' : '/en/' }
  : { label: 'Version française', href: currentPath.startsWith('/en/blog') ? '/blog' : currentPath === '/en/about' ? '/a-propos' : '/' };
---
<header class="fixed top-0 z-40 w-full border-b border-foreground/10 bg-background/90 backdrop-blur dark:border-background-dark/40 dark:bg-background-dark/90">
  <div class="app-container flex items-center justify-between py-4">
    <a href={lang === 'fr' ? '/' : '/en/'} class="flex items-center gap-3" aria-label="{SITE_TITLE}">
      <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-primary text-background shadow-lg shadow-primary/30 dark:bg-primary-dark dark:text-foreground">
        <span class="text-lg font-black tracking-tight">FM</span>
      </div>
      <div class="leading-tight">
        <p class="text-lg font-bold">{SITE_TITLE}</p>
        <p class="text-sm text-foreground/70 dark:text-foreground-dark/70">{BASELINE}</p>
      </div>
    </a>

    <div class="hidden items-center gap-8 md:flex">
      {nav.map((item) => (
        <NavbarLink href={item.href} currentPath={currentPath}>
          {item.label}
        </NavbarLink>
      ))}
    </div>

    <div class="flex items-center gap-3">
      <ThemeSelector class="hidden md:flex" />
      <a
        class="hidden rounded-full border border-foreground/15 px-4 py-2 text-sm font-semibold text-foreground/80 transition hover:border-primary hover:text-primary dark:border-background-dark/40 dark:text-foreground-dark/80 dark:hover:text-primary-dark md:inline-flex"
        href={languageSwitch.href}
      >
        {languageSwitch.label}
      </a>
      <button
        class="md:hidden rounded-full border border-foreground/15 p-2 text-foreground/80 transition hover:border-primary hover:text-primary dark:border-background-dark/40 dark:text-foreground-dark/80 dark:hover:text-primary-dark"
        id="nav-open-btn"
        aria-label="Ouvrir le menu"
        title="Ouvrir le menu"
        type="button"
      >
        <Icon aria-hidden name="mdi:menu" size={28} />
      </button>
    </div>
  </div>

  <div
    class="fixed right-0 top-0 z-40 h-screen w-5/6 translate-x-full border-l border-foreground/10 bg-background px-8 py-6 transition-transform dark:border-background-dark/40 dark:bg-background-dark md:hidden"
    id="mobile-menu"
  >
    <button
      id="nav-close-btn"
      class="ml-auto block rounded-full border border-foreground/15 p-2 text-foreground/80 transition hover:border-primary hover:text-primary dark:border-background-dark/40 dark:text-foreground-dark/80 dark:hover:text-primary-dark"
      aria-label="Fermer le menu"
      title="Fermer le menu"
      type="button"
    >
      <Icon aria-hidden name="mdi:close" size={28} />
    </button>
    <div class="flex h-full flex-col items-start gap-6 pt-12">
      {nav.map((item) => (
        <NavbarLink class="text-3xl font-light" href={item.href} currentPath={currentPath}>
          {item.label}
        </NavbarLink>
      ))}
      <a
        class="rounded-full border border-foreground/15 px-4 py-2 text-sm font-semibold text-foreground/80 transition hover:border-primary hover:text-primary dark:border-background-dark/40 dark:text-foreground-dark/80 dark:hover:text-primary-dark"
        href={languageSwitch.href}
      >
        {languageSwitch.label}
      </a>
      <ThemeSelector class="mt-4" />
    </div>
  </div>
</header>

<script>
  function toggleNav() {
    document.querySelector('#mobile-menu')?.classList.toggle('mobile-nav-open');
  }

  document.querySelector('#nav-open-btn')?.addEventListener('click', toggleNav);
  document.querySelector('#nav-close-btn')?.addEventListener('click', toggleNav);
</script>

<script is:inline>
  (function() {
    // Theme management
    function applyTheme() {
      if (
        localStorage.theme === 'dark' ||
        (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    }

    function updateActiveButton() {
      const theme = localStorage.theme || 'auto';
      document.querySelectorAll('.theme-button').forEach((el) => {
        const isActive = el.dataset.theme === 'theme-' + theme;
        el.classList.toggle('active', isActive);
      });
    }

    function handleThemeClick(e) {
      const button = e.currentTarget;
      if (!button || !button.dataset.theme) return;
      
      const theme = button.dataset.theme;
      
      if (theme === 'theme-auto') {
        localStorage.removeItem('theme');
      } else {
        localStorage.theme = theme.replace('theme-', '');
      }
      
      applyTheme();
      updateActiveButton();
    }

    function initThemeButtons() {
      document.querySelectorAll('.theme-button').forEach((button) => {
        // Remove old listeners
        const newButton = button.cloneNode(true);
        button.parentNode?.replaceChild(newButton, button);
        
        // Add new listener
        newButton.addEventListener('click', handleThemeClick);
      });
    }

    // Apply theme immediately to prevent flash
    applyTheme();

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initThemeButtons();
        updateActiveButton();
      });
    } else {
      initThemeButtons();
      updateActiveButton();
    }

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (!localStorage.theme) {
        applyTheme();
      }
    });
  })();
</script>
