---
import type { Heading } from '../../utils/headings';

interface Props {
  headings: Heading[];
  title?: string;
}

const { headings = [], title = 'On this page' } = Astro.props;
const hasHeadings = headings.length > 0;
---

{hasHeadings && (
  <aside class="sidebar" aria-label="Article sections">
    <nav class="sidebar-nav">
      <button
        class="sidebar-toggle"
        aria-expanded="false"
        aria-controls="sidebar-content"
        aria-label="Toggle article sections menu"
      >
        <span class="sidebar-toggle-text">{title}</span>
        <svg
          class="sidebar-toggle-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </button>

      <div class="sidebar-content" id="sidebar-content">
        <ul class="sidebar-list">
          {headings.map((heading) => (
            <li class="sidebar-item">
              <a
                href={`#${heading.id}`}
                class="sidebar-link"
                data-level={heading.level}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </nav>
  </aside>
)}

<style>
  .sidebar {
    @apply sticky top-28 hidden h-fit max-w-xs flex-shrink-0 lg:block;
  }

  .sidebar-nav {
    @apply space-y-4;
  }

  .sidebar-toggle {
    @apply hidden w-full items-center justify-between rounded-md border border-foreground/10 bg-background/70 px-4 py-2.5 text-left font-semibold text-foreground transition hover:bg-background/90 dark:border-foreground-dark/10 dark:bg-background-dark/50 dark:text-foreground-dark dark:hover:bg-background-dark/70;
  }

  .sidebar-toggle-icon {
    @apply h-5 w-5 transition-transform duration-200;
  }

  .sidebar-content {
    @apply h-auto max-h-none opacity-100 transition-all duration-200;
  }

  .sidebar-list {
    @apply space-y-2;
  }

  .sidebar-item {
    @apply list-none;
  }

  .sidebar-link {
    @apply block rounded-md px-3 py-1.5 text-sm text-foreground/70 transition-colors hover:text-foreground dark:text-foreground-dark/70 dark:hover:text-foreground-dark;
  }

  .sidebar-link:focus-visible {
    @apply outline-2 outline-offset-2 outline-primary dark:outline-primary-dark;
  }

  .sidebar-link[href]:hover {
    @apply bg-foreground/5 dark:bg-foreground-dark/10;
  }

  /* Mobile styles */
  @media (max-width: 1023px) {
    .sidebar {
      @apply block sticky top-20 w-full max-w-none;
    }

    .sidebar-toggle {
      @apply flex;
    }

    .sidebar-toggle[aria-expanded='true'] .sidebar-toggle-icon {
      @apply rotate-180;
    }

    .sidebar-content {
      @apply max-h-0 overflow-hidden opacity-0;
    }

    .sidebar-toggle[aria-expanded='true'] + .sidebar-content {
      @apply max-h-96 opacity-100;
    }
  }
</style>

<script>
  // Toggle sidebar on mobile
  const toggleButtons = document.querySelectorAll('.sidebar-toggle');

  toggleButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const isExpanded = button.getAttribute('aria-expanded') === 'true';
      button.setAttribute('aria-expanded', (!isExpanded).toString());
    });

    // Close sidebar when clicking a link
    const contentDiv = document.getElementById(button.getAttribute('aria-controls') || '');
    if (contentDiv) {
      contentDiv.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', () => {
          button.setAttribute('aria-expanded', 'false');
        });
      });
    }
  });

  // Highlight current section based on scroll position
  const links = document.querySelectorAll('.sidebar-link');
  const headingElements = Array.from(
    document.querySelectorAll('h2[id]')
  ) as HTMLHeadingElement[];

  if (headingElements.length > 0) {
    const observer = new IntersectionObserver(
      (entries) => {
        // Find which heading is in view
        const visibleHeading = entries
          .filter((e) => e.isIntersecting)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top)[0];

        // Remove active class from all links
        links.forEach((link) => {
          link.classList.remove('active');
        });

        // Add active class to matching link
        if (visibleHeading) {
          const activeLink = document.querySelector(
            `.sidebar-link[href="#${visibleHeading.id}"]`
          );
          if (activeLink) {
            activeLink.classList.add('active');
          }
        }
      },
      {
        rootMargin: '-80px 0px -66% 0px',
      }
    );

    headingElements.forEach((heading) => {
      observer.observe(heading);
    });
  }
</script>

<style is:global>
  .sidebar-link.active {
    @apply bg-primary/10 font-semibold text-primary dark:bg-primary-dark/15 dark:text-primary-dark;
  }
</style>
