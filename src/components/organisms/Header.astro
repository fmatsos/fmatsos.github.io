---
import { BASELINE, SITE_TITLE } from '../../config';
import NavItem from '../molecules/NavItem.astro';
import IconButton from '../atoms/IconButton.astro';
import SkipLink from '../atoms/SkipLink.astro';

interface Props {
  lang: 'fr' | 'en';
  currentPath?: string;
}

const { lang, currentPath = '/' } = Astro.props as Props;

const navDesktop = lang === 'fr'
  ? [
      { href: '/blog', label: 'Blog' },
      { href: '/experiences', label: 'Expériences' },
      { href: '/a-propos', label: 'À propos' },
    ]
  : [
      { href: '/en/blog', label: 'Blog' },
      { href: '/en/experiences', label: 'Experience' },
      { href: '/en/about', label: 'About' },
    ];

const navMobile = lang === 'fr'
  ? [
      { href: '/', label: 'Accueil' },
      { href: '/blog', label: 'Blog' },
      { href: '/experiences', label: 'Expériences' },
      { href: '/a-propos', label: 'À propos' },
    ]
  : [
      { href: '/en/', label: 'Home' },
      { href: '/en/blog', label: 'Blog' },
      { href: '/en/experiences', label: 'Experience' },
      { href: '/en/about', label: 'About' },
    ];

const openMenuText = lang === 'fr' ? 'Ouvrir le menu' : 'Open menu';
const closeMenuText = lang === 'fr' ? 'Fermer le menu' : 'Close menu';
---

<SkipLink to="main-content">
  {lang === 'fr' ? 'Aller au contenu principal' : 'Skip to main content'}
</SkipLink>

<header class="border-b border-black/15 dark:border-white/20" role="banner">
  <div class="container mx-auto flex items-center justify-between px-4 py-6 sm:px-6">
    <a
      href={lang === 'fr' ? '/' : '/en/'}
      class="logo-link group relative text-lg font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 overflow-hidden"
      aria-label={SITE_TITLE}
    >
      <span class="logo-text inline-block md:transition-opacity md:duration-500 md:ease-in-out md:group-hover:opacity-0">
        {SITE_TITLE}
      </span>
      <span class="logo-home absolute inset-0 hidden md:flex items-center gap-2 opacity-0 transition-opacity duration-500 ease-in-out delay-100 group-hover:opacity-100 text-black dark:text-white">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span class="text-lg font-semibold">{lang === 'fr' ? 'Accueil' : 'Home'}</span>
      </span>
    </a>

    <nav class="hidden items-center gap-8 md:flex" aria-label={lang === 'fr' ? 'Navigation principale' : 'Main navigation'}>
      {navDesktop.map((item) => (
        <NavItem href={item.href} currentPath={currentPath} lang={lang}>
          {item.label}
        </NavItem>
      ))}
    </nav>

    <div class="flex items-center gap-3">
      <!-- Language Switcher -->
      <a
        href={lang === 'fr' ? '/en/' : '/'}
        class="text-xs font-semibold uppercase tracking-wider text-black/60 dark:text-white/60 hover:text-black dark:hover:text-white transition-colors"
        title={lang === 'fr' ? 'Switch to English' : 'Passer au français'}
      >
        {lang === 'fr' ? 'EN' : 'FR'}
      </a>

      <div class="hidden md:flex" id="theme-selector-desktop">
        <slot name="theme-selector" />
      </div>
      <IconButton
        icon="mdi:menu"
        ariaLabel={openMenuText}
        title={openMenuText}
        id="nav-open-btn"
        aria-expanded="false"
        aria-controls="mobile-menu"
        class="md:hidden"
      />
    </div>
  </div>

  <div
    class="fixed right-0 top-0 z-40 h-screen w-5/6 max-w-sm translate-x-full border-l border-foreground/10 bg-background px-8 py-6 transition-transform dark:border-background-dark/40 dark:bg-background-dark md:hidden"
    id="mobile-menu"
    role="navigation"
    aria-label={lang === 'fr' ? 'Menu mobile' : 'Mobile menu'}
    aria-hidden="true"
  >
    <IconButton
      icon="mdi:close"
      ariaLabel={closeMenuText}
      title={closeMenuText}
      id="nav-close-btn"
      class="ml-auto block"
    />
    <nav class="flex h-full flex-col items-start gap-6 pt-12" aria-label={lang === 'fr' ? 'Navigation mobile' : 'Mobile navigation'}>
      {navMobile.map((item) => (
        <NavItem class="text-3xl font-light" href={item.href} currentPath={currentPath} lang={lang}>
          {item.label}
        </NavItem>
      ))}
      <div class="mt-4" id="theme-selector-mobile">
        <slot name="theme-selector" />
      </div>
    </nav>
  </div>
</header>

<script>
  function toggleNav() {
    const menu = document.querySelector('#mobile-menu');
    const openBtn = document.querySelector('#nav-open-btn');
    menu?.classList.toggle('mobile-nav-open');
    const isOpen = menu?.classList.contains('mobile-nav-open');
    
    // Update aria-expanded and aria-hidden
    if (openBtn) {
      openBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    }
    if (menu) {
      menu.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    }
    
    // Manage focus
    if (isOpen) {
      document.querySelector<HTMLElement>('#nav-close-btn')?.focus();
    } else {
      document.querySelector<HTMLElement>('#nav-open-btn')?.focus();
    }
    
    // Prevent body scroll when menu is open
    document.body.style.overflow = isOpen ? 'hidden' : '';
  }

  document.querySelector('#nav-open-btn')?.addEventListener('click', toggleNav);
  document.querySelector('#nav-close-btn')?.addEventListener('click', toggleNav);

  // Close menu on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.querySelector('#mobile-menu')?.classList.contains('mobile-nav-open')) {
      toggleNav();
    }
  });

  // Close menu when clicking outside
  document.addEventListener('mousedown', (e) => {
    const menu = document.querySelector('#mobile-menu');
    if (menu?.classList.contains('mobile-nav-open') && !menu.contains(e.target as Node) && e.target !== document.querySelector('#nav-open-btn')) {
      toggleNav();
    }
  });
</script>

<script is:inline>
  (function() {
    // Theme management
    function applyTheme() {
      if (
        localStorage.theme === 'dark' ||
        (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    }

    function updateActiveButton() {
      const theme = localStorage.theme || 'auto';
      document.querySelectorAll('.theme-button').forEach((el) => {
        const isActive = el.dataset.theme === 'theme-' + theme;
        el.classList.toggle('active', isActive);
      });
    }

    function handleThemeClick(e) {
      const button = e.currentTarget;
      if (!button || !button.dataset.theme) return;
      
      const theme = button.dataset.theme;
      
      if (theme === 'theme-auto') {
        localStorage.removeItem('theme');
      } else {
        localStorage.theme = theme.replace('theme-', '');
      }
      
      applyTheme();
      updateActiveButton();
    }

    function initThemeButtons() {
      document.querySelectorAll('.theme-button').forEach((button) => {
        // Remove old listeners
        const newButton = button.cloneNode(true);
        button.parentNode?.replaceChild(newButton, button);
        
        // Add new listener
        newButton.addEventListener('click', handleThemeClick);
      });
    }

    // Apply theme immediately to prevent flash
    applyTheme();

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initThemeButtons();
        updateActiveButton();
      });
    } else {
      initThemeButtons();
      updateActiveButton();
    }

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (!localStorage.theme) {
        applyTheme();
      }
    });
  })();
</script>
